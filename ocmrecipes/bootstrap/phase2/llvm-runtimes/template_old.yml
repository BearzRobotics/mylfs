name: llvm
version: 17.0.9        # Example LLVM release, adjust as needed
release: 1
url: https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-21.1.8.tar.gz
homepage: https://llvm.org/

license: Apache-2.0
summary: LLVM binutils-equivalents (ar, ranlib, strip, nm, linker)
description: |
  LLVM provides replacements for GNU binutils tools including llvm-ar, llvm-ranlib, llvm-strip, llvm-nm, and the LLD linker.
  These tools can be used with clang to build a complete system without GNU binutils.




buildsteps: |
  # Set up sysroot for musl
  export CC="musl-clang"
  export CXX="clang++"
  export CFLAGS="--sysroot=$LFS -I$LFS/usr/include -static"
  export CXXFLAGS="--sysroot=$LFS -I$LFS/usr/include"
  export LDFLAGS="--sysroot=$LFS -L$LFS/lib"
  export PM=$(grep -c processor /proc/cpuinfo)

  # Libcxx headers
  ###############################################
  mkdir -pv build-libcxx-headers
  cd build-libcxx-headers

  cmake ../libcxx \
    -G "Unix Makefiles" \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_SYSROOT=$LFS \
    -DCMAKE_C_COMPILER=musl-clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DLIBCXX_ENABLE_SHARED=OFF \
    -DLIBCXX_ENABLE_STATIC=OFF \
    -DLIBCXX_ENABLE_FILESYSTEM=OFF \
    -DLIBCXX_INCLUDE_TESTS=OFF \
    -DLIBCXX_ENABLE_EXPERIMENTAL_LIBRARY=OFF \
    -DLIBCXX_ENABLE_ABI_LINKER_SCRIPT=OFF \
    -DLIBCXX_INSTALL_HEADERS=ON

  make install-headers


  # libunwind
  ################################
  cd ..
  mkdir -vp build-libunwind
  cd build-libunwind

  cmake ../libunwind \
    -G "Unix Makefiles" \
    -DCMAKE_INSTALL_PREFIX=$LFS/usr \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DCMAKE_SYSROOT=$LFS \
    -DCMAKE_BUILD_TYPE=Release \
    -DLIBUNWIND_ENABLE_SHARED=ON \
    -DLIBUNWIND_ENABLE_STATIC=ON \
    -DLIBUNWIND_USE_COMPILER_RT=ON

  make && make install


  # libc++abi
  #################################3
  cd ..
  mkdir -vp build-libcxxabi

  cd build-libcxxabi

  cmake ../libcxxabi \
    -G "Unix Makefiles" \
    -DCMAKE_INSTALL_PREFIX=$LFS/usr \
    -DCMAKE_C_COMPILER=clang \
    -DCMAKE_CXX_COMPILER=clang++ \
    -DCMAKE_SYSROOT=$LFS \
    -DCMAKE_BUILD_TYPE=Release \
    -DLIBCXXABI_USE_LLVM_UNWINDER=ON \
    -DLIBCXXABI_ENABLE_SHARED=ON \
    -DLIBCXXABI_ENABLE_STATIC=ON \
    -DLIBCXXABI_ENABLE_EXCEPTIONS=ON \
    -DLLVM_ENABLE_RUNTIMES=libunwind

  make && make install

  # build libcxx
  ######################################
  cd ..
  
  cmake ../libcxx \
  -G "Unix Makefiles" \
  -DCMAKE_INSTALL_PREFIX=$LFS/usr \
  -DCMAKE_C_COMPILER=clang \
  -DCMAKE_CXX_COMPILER=clang++ \
  -DCMAKE_SYSROOT=$LFS \
  -DCMAKE_BUILD_TYPE=Release \
  -DLIBCXX_ENABLE_SHARED=ON \
  -DLIBCXX_ENABLE_STATIC=ON \
  -DLIBCXX_USE_COMPILER_RT=ON \
  -DLIBCXX_CXX_ABI=libcxxabi

  make && make install

  # LLVM+Clang
  #############################
  # Create separate build directory
  cd ..
  mkdir -pv build
  cd build

  # Configure LLVM via CMake
  cmake -G "Unix Makefiles" \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=$LFS \
    -DLLVM_ENABLE_PROJECTS="clang;lld;libcxx;libcxxabi;libunwind" \
    -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLVM_ENABLE_THREADS=OFF \
    -DLLVM_ENABLE_TERMINFO=OFF \
    -DLLVM_ENABLE_LIBCXX=ON \
    -DLLVM_ENABLE_LIBCXXABI=ON \
    -DLLVM_ENABLE_UNWIND=ON \
    ../llvm

  # Build essential binutils + clang + libc++ tools
  make -j$(nproc) \
       llvm-ar llvm-ranlib llvm-strip llvm-nm lld \
       llvm-addr2line llvm-cxxfilt llvm-symbolizer llvm-size llvm-objdump \
       clang clang++ \
       cxxabi cxx

  # Install everything to $LFS
  make install

  # Symlink binutils replacements to GNU-style names for compatibility
  ln -sv $LFS/bin/llvm-ar       $LFS/bin/ar
  ln -sv $LFS/bin/llvm-ranlib   $LFS/bin/ranlib
  ln -sv $LFS/bin/llvm-strip    $LFS/bin/strip
  ln -sv $LFS/bin/llvm-nm       $LFS/bin/nm
  ln -sv $LFS/bin/lld           $LFS/bin/ld
  ln -sv $LFS/bin/llvm-addr2line $LFS/bin/addr2line
  ln -sv $LFS/bin/llvm-cxxfilt  $LFS/bin/c++filt
  ln -sv $LFS/bin/llvm-symbolizer $LFS/bin/symbolizer
  ln -sv $LFS/bin/llvm-size      $LFS/bin/size
  ln -sv $LFS/bin/llvm-objdump   $LFS/bin/objdump



  # Experemntal
  cmake -G "Unix Makefiles" ../llvm \
  -DCMAKE_INSTALL_PREFIX=/dbin \
  -DCMAKE_C_COMPILER=clang \
  -DCMAKE_CXX_COMPILER=clang++ \
  -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld" \
  -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;compiler-rt" \
  -DCLANG_ENABLE_BOOTSTRAP=ON \
  -DLLVM_TARGETS_TO_BUILD="X86" \
  -DLLVM_ENABLE_RUNTIMES_BLAKE3=OFF \
  -DCMAKE_BUILD_TYPE=Release

  make -j$(nproc)
  make install





   # LLVM+Clang
  #############################
  # Create separate build directory
  cd ..
  mkdir -pv build
  cd build

  # Configure LLVM via CMake
  cmake -G "Unix Makefiles" \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=$LFS \
    -DLLVM_ENABLE_PROJECTS="clang;lld;libcxx;libcxxabi;libunwind" \
    -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \
    -DLLVM_TARGETS_TO_BUILD="X86" \
    -DLLVM_ENABLE_THREADS=OFF \
    -DLLVM_ENABLE_TERMINFO=OFF \
    -DLLVM_ENABLE_LIBCXX=ON \
    -DLLVM_ENABLE_LIBCXXABI=ON \
    -DLLVM_ENABLE_UNWIND=ON \
    ../llvm

  # Build essential binutils + clang + libc++ tools
  make -j$(nproc) \
       llvm-ar llvm-ranlib llvm-strip llvm-nm lld \
       llvm-addr2line llvm-cxxfilt llvm-symbolizer llvm-size llvm-objdump \
       clang clang++ \
       cxxabi cxx

  # Install everything to $LFS
  make install

  # Symlink binutils replacements to GNU-style names for compatibility
  ln -sv $LFS/bin/llvm-ar       $LFS/bin/ar
  ln -sv $LFS/bin/llvm-ranlib   $LFS/bin/ranlib
  ln -sv $LFS/bin/llvm-strip    $LFS/bin/strip
  ln -sv $LFS/bin/llvm-nm       $LFS/bin/nm
  ln -sv $LFS/bin/lld           $LFS/bin/ld
  ln -sv $LFS/bin/llvm-addr2line $LFS/bin/addr2line
  ln -sv $LFS/bin/llvm-cxxfilt  $LFS/bin/c++filt
  ln -sv $LFS/bin/llvm-symbolizer $LFS/bin/symbolizer
  ln -sv $LFS/bin/llvm-size      $LFS/bin/size
  ln -sv $LFS/bin/llvm-objdump   $LFS/bin/objdump



  # Experemntal
  cmake -G "Unix Makefiles" ../llvm \
  -DCMAKE_INSTALL_PREFIX=/dbin \
  -DCMAKE_C_COMPILER=clang \
  -DCMAKE_CXX_COMPILER=clang++ \
  -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld" \
  -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;compiler-rt;libunwind" \
  -DCLANG_ENABLE_BOOTSTRAP=ON \
  -DLLVM_TARGETS_TO_BUILD="X86" \
  -DLLVM_ENABLE_RUNTIMES_BLAKE3=OFF \
  -DCMAKE_BUILD_TYPE=Release

  make -j$(nproc)
  make install